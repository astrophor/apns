package apns

import (
	"testing"
	"time"
)

func TestApnsNormal(t *testing.T) {
	apnsHandler, err := Connect("./test.pem", "./test.pem", false)
	if err != nil {
		t.Errorf("connect to apns failed: %v", err)
	}

	text := `{"aps":{"alert":"hello, world"}}`
	msg := Message{
		Token:   "xxx",
		Payload: []byte(text),
	}

	if err := apnsHandler.Send(msg); err != nil {
		t.Error(err)
	}

	time.Sleep(2 * time.Second)

	msg.Token = "xxx"
	if err := apnsHandler.Send(msg); err != nil {
		t.Error(err)
	}

	msg.Token = "xxx"
	if err := apnsHandler.Send(msg); err == nil {
		t.Error("wrong result for invalid token")
	}

	msg.Token = "xxx"
	msg.Payload = []byte("111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111")
	if err := apnsHandler.Send(msg); err == nil {
		t.Error("wrong result for long payload")
	}

	apnsHandler.Close()
}
